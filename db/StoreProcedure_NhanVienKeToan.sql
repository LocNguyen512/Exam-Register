-- Thêm dữ liệu vào bảng NHAN_VIEN
INSERT INTO NHAN_VIEN (MA_NV, HOTEN, CCCD, SDT, EMAIL, LOAINV)
VALUES 
('NV0001', N'Nguyễn Văn A', '123456789012', '0123456789', 'a@domain.com', N'Nhập liệu'),
('NV0002', N'Nguyễn Thị B', '234567890123', '0987654321', 'b@domain.com', N'Tiếp nhận'),
('NV0003', N'Phạm Quốc C', '345678901234', '0912345678', 'c@domain.com', N'Kế toán');

-- Thêm dữ liệu vào bảng THI_SINH
INSERT INTO THI_SINH (MA_TS, HOTEN, CCCD, NGAYSINH, SDT, EMAIL)
VALUES 
('TS0001', N'Nguyễn Quang D', '456789012345', '1990-05-15', '0911223344', 'd@domain.com'),
('TS0002', N'Phan Thị E', '567890123456', '1992-06-22', '0909888777', 'e@domain.com'),
('TS0003', N'Hoàng Minh F', '678901234567', '1995-08-30', '0922334455', 'f@domain.com');
-- Thêm dữ liệu vào bảng KHACH_HANG
INSERT INTO KHACH_HANG (MA_KH, SDT, EMAIL, LOAIKH)
VALUES 
('KH0001', '0912345678', 'kh1@domain.com', N'Tự do'),
('KH0002', '0922334455', 'kh2@domain.com', N'Đơn vị');

-- Thêm dữ liệu vào bảng KHACH_HANG_TUDO
INSERT INTO KHACH_HANG_TUDO (MA_KHTD, HOTEN)
VALUES 
('KH0001', N'Nguyễn Văn G')
-- Thêm dữ liệu vào bảng KHACH_HANG_DONVI
INSERT INTO KHACH_HANG_DONVI (MA_KHDV, TENDONVI, DIACHI)
VALUES 
('KH0002', N'Công ty XYZ', N'456 Đường XYZ, Quận 2');

-- Thêm dữ liệu vào bảng PHIEU_GIA_HAN
INSERT INTO PHIEU_GIA_HAN (MA_PGH, NGAYLAP, MON, TRUONGHOP, PHI, TINHTRANG, MA_NVTN, MA_NVKT, MA_TS)
VALUES 
('GH0001', '2025-04-01', N'Tin học', N'Không đặc biệt', 500000, N'Chưa thanh toán', 'NV0001', 'NV0002', 'TS0001');

-- Thêm dữ liệu vào bảng PHIEU_DANG_KY
INSERT INTO PHIEU_DANG_KY (MA_PDK, NGAYLAP, SOLUONG, MA_NV, MA_KH)
VALUES 
('DK0001', '2025-04-01', 2, 'NV0001', 'KH0001'),
('DK0002', '2025-04-02', 1, 'NV0002', 'KH0002');


INSERT INTO LOAI_DGNL (MA_LOAI, TENLOAI, GIATIEN)
VALUES 
('NL0001', N'Tin học cơ bản', 500000),
('NL0002', N'Anh văn', 600000);

-- Thêm dữ liệu vào bảng LICH_THI
INSERT INTO LICH_THI (MA_LICH, NGAYTHI, GIOTHI, MA_LOAI)
VALUES 
('LT0001', '2025-04-10', '08:00:00', 'NL0001'),
('LT0002', '2025-04-12', '10:00:00', 'NL0002');

INSERT INTO PHONG_THI (MA_PHONG, TENPHONG, SOGHETOIDA)
VALUES 
('PT0001', N'Phòng A', 30),
('PT0002', N'Phòng B', 25);

INSERT INTO CHI_TIET_LICH_THI (MA_LICH, MA_PHONG, SOGHETRONG)
VALUES 
('LT0001', 'PT0001', 25),
('LT0002', 'PT0002', 20);

-- Thêm dữ liệu vào bảng CHI_TIET_DANG_KY
INSERT INTO CHI_TIET_DANG_KY (MA_PDK, MA_TS, SOLANGIAHAN, SOBAODANH, MA_PHONG, MA_LICH)
VALUES 
('DK0001', 'TS0001', 1, 'B001', 'PT0001', 'LT0001'),
('DK0002', 'TS0002', 2, 'B002', 'PT0002', 'LT0002');

-- Thêm dữ liệu vào bảng PHIEU_THANH_TOAN
INSERT INTO PHIEU_THANH_TOAN (MA_PTT, TINHTRANG, NGAYLAP, MA_NV, MA_PDK)
VALUES 
('TT0001', N'Chưa thanh toán', '2025-04-01', 'NV0003', 'DK0001'),
('TT0002', N'Đã thanh toán', '2025-04-02', 'NV0003', 'DK0002');

INSERT INTO CHUNG_CHI (MA_CC, NGAYCAP, MONTHI, GHICHU, KETQUA, TRANGTHAI, MA_TS, MA_NV)
VALUES 
('CC0001', '2025-04-01', N'Tin học cơ bản', N'Chứng chỉ tin học', 85, N'Đã nhận', 'TS0001', 'NV0001'),
('CC0002', '2025-04-02', N'Anh văn', N'Chứng chỉ Anh văn', 90, N'Chưa nhận', 'TS0002', 'NV0002');

-- Thêm dữ liệu vào bảng USERS
INSERT INTO USERS (MA_NV, TAIKHOAN, MATKHAU)
VALUES 
('NV0001', 'user1', 'password1'),
('NV0002', 'user2', 'password2');


--Sp tìm kiếm ở trang của nhân viên kế toán - khách hàng tự do 
use EXAM_REGISTER
go 

CREATE PROCEDURE SP_NVKT_TimKiemKHTD_Theo_CCCD
    @CCCD CHAR(12)
AS
BEGIN
    SELECT 
        TS.MA_TS,
        TS.HOTEN,
        TS.NGAYSINH,
        TS.CCCD,
        KH_TD.HOTEN AS NguoiDangKy,
        SUM(LD.GIATIEN) AS SoTienCanTra,
        MAX(PTT.TINHTRANG) AS TinhTrangThanhToan
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KH_TD ON KH.MA_KH = KH_TD.MA_KHTD
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    LEFT JOIN PHIEU_THANH_TOAN PTT ON PDK.MA_PDK = PTT.MA_PDK
    WHERE TS.CCCD = @CCCD
    GROUP BY TS.MA_TS, TS.HOTEN, TS.NGAYSINH, TS.CCCD, KH_TD.HOTEN
END

EXEC SP_NVKT_TimKiemKHTD_Theo_CCCD @CCCD='456789012345'

Create PROCEDURE SP_NVKT_TimKiemKHTD_Theo_MA_TS
    @MA_TS CHAR(6)
AS
BEGIN
    SELECT 
        TS.MA_TS,
        TS.HOTEN,
        TS.NGAYSINH,
        TS.CCCD,
        KH_TD.HOTEN AS NguoiDangKy,
        SUM(LD.GIATIEN) AS SoTienCanTra,
        MAX(PTT.TINHTRANG) AS TinhTrangThanhToan
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KH_TD ON KH.MA_KH = KH_TD.MA_KHTD
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    LEFT JOIN PHIEU_THANH_TOAN PTT ON PDK.MA_PDK = PTT.MA_PDK
    WHERE TS.MA_TS = @MA_TS
    GROUP BY TS.MA_TS, TS.HOTEN, TS.NGAYSINH, TS.CCCD, KH_TD.HOTEN
END

EXEC SP_NVKT_TimKiemKHTD_Theo_MA_TS @MA_TS='TS0001'

CREATE PROCEDURE SP_NVKT_TimKiemKHTD_Theo_Ten_TS
    @HOTEN NVARCHAR(50)
AS
BEGIN
    SELECT 
        TS.MA_TS,
        TS.HOTEN,
        TS.NGAYSINH,
        TS.CCCD,
        KH_TD.HOTEN AS NguoiDangKy,
        SUM(LD.GIATIEN) AS SoTienCanTra,
        MAX(PTT.TINHTRANG) AS TinhTrangThanhToan
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KH_TD ON KH.MA_KH = KH_TD.MA_KHTD
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    LEFT JOIN PHIEU_THANH_TOAN PTT ON PDK.MA_PDK = PTT.MA_PDK
    WHERE TS.HOTEN LIKE '%' + @HOTEN + '%'
    GROUP BY TS.MA_TS, TS.HOTEN, TS.NGAYSINH, TS.CCCD, KH_TD.HOTEN
END

EXEC SP_NVKT_TimKiemKHTD_Theo_Ten_TS @HOTEN=N'Nguyễn Quang D'


Create PROCEDURE SP_NVKT_TimChungChiKHTD_Theo_CCCD
    @CCCD CHAR(12)
AS
BEGIN
    SELECT 
        CC.MONTHI AS ChungChiDangKy,
        LD.GIATIEN AS Gia
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KHTD ON KH.MA_KH = KHTD.MA_KHTD
    JOIN CHUNG_CHI CC ON TS.MA_TS = CC.MA_TS 
    WHERE TS.CCCD = @CCCD
END
GO
Exec SP_NVKT_TimChungChiKHTD_Theo_CCCD @CCCD='456789012345'

CREATE PROCEDURE SP_NVKT_TimChungChiKHTD_Theo_Ma_TS
    @MA_TS CHAR(6)
AS
BEGIN
    SELECT 
        CC.MONTHI AS TenChungChi,
        LD.GIATIEN
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KHTD ON KH.MA_KH = KHTD.MA_KHTD
    JOIN CHUNG_CHI CC ON TS.MA_TS = CC.MA_TS 
    WHERE TS.MA_TS = @MA_TS
END
GO

EXEC SP_NVKT_TimChungChiKHTD_Theo_MA_TS @MA_TS='TS0001'

Alter PROCEDURE SP_NVKT_TimChungChiKHTD_Theo_Ten
    @HOTEN NVARCHAR(50)
AS
BEGIN
    SELECT 
        CC.MONTHI AS TenChungChi,
        LD.GIATIEN
    FROM THI_SINH TS
    JOIN CHI_TIET_DANG_KY CTDK ON TS.MA_TS = CTDK.MA_TS
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    JOIN PHIEU_DANG_KY PDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN KHACH_HANG KH ON PDK.MA_KH = KH.MA_KH
    JOIN KHACH_HANG_TUDO KHTD ON KH.MA_KH = KHTD.MA_KHTD
    JOIN CHUNG_CHI CC ON TS.MA_TS = CC.MA_TS 
    WHERE TS.HOTEN LIKE N'%' + @HOTEN + '%'
END
GO

EXEC SP_NVKT_TimChungChiKHTD_Theo_Ten @HOTEN=N'Nguyễn Quang D'



--Tìm kiếm ở trang nhân viên kế toán - khách hàng đơn vị
CREATE PROCEDURE SP_NVKT_TimKiemKHDV_Theo_Ten
    @TENDONVI NVARCHAR(50)
AS
BEGIN
    SELECT 
        KHDV.TENDONVI,
        KH.EMAIL,
        SUM(LD.GIATIEN) AS TongTienCanTra,
        MAX(PTT.TINHTRANG) AS TinhTrangThanhToan
    FROM KHACH_HANG_DONVI KHDV
    JOIN KHACH_HANG KH ON KHDV.MA_KHDV = KH.MA_KH
    JOIN PHIEU_DANG_KY PDK ON KH.MA_KH = PDK.MA_KH
    JOIN CHI_TIET_DANG_KY CTDK ON PDK.MA_PDK = CTDK.MA_PDK
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    LEFT JOIN PHIEU_THANH_TOAN PTT ON PDK.MA_PDK = PTT.MA_PDK
    WHERE KHDV.TENDONVI LIKE N'%' + @TENDONVI + '%'
    GROUP BY KHDV.TENDONVI, KH.EMAIL
END
GO
EXEC SP_NVKT_TimKiemKHDV_Theo_Ten @TENDONVI=N'Công ty XYZ'

CREATE PROCEDURE SP_NVKT_TimKiemKHDV_Theo_Ma_DV
    @MA_KH CHAR(6)
AS
BEGIN
    SELECT 
        KHDV.TENDONVI,
        KH.EMAIL,
        SUM(LD.GIATIEN) AS TongTienCanTra,
        MAX(PTT.TINHTRANG) AS TinhTrangThanhToan
    FROM KHACH_HANG_DONVI KHDV
    JOIN KHACH_HANG KH ON KHDV.MA_KHDV = KH.MA_KH
    JOIN PHIEU_DANG_KY PDK ON KH.MA_KH = PDK.MA_KH
    JOIN CHI_TIET_DANG_KY CTDK ON PDK.MA_PDK = CTDK.MA_PDK
    JOIN LICH_THI LT ON CTDK.MA_LICH = LT.MA_LICH
    JOIN LOAI_DGNL LD ON LT.MA_LOAI = LD.MA_LOAI
    LEFT JOIN PHIEU_THANH_TOAN PTT ON PDK.MA_PDK = PTT.MA_PDK
    WHERE KH.MA_KH = @MA_KH
    GROUP BY KHDV.TENDONVI, KH.EMAIL
END
GO
EXEC SP_NVKT_TimKiemKHDV_Theo_Ma_DV @MA_KH='KH0002'

CREATE PROCEDURE SP_NVKT_TimChungChiKHDV_Theo_Ma_DV
    @MA_KH CHAR(6)
AS
BEGIN
    SELECT 
        LD.TENLOAI AS TENCHUNGCHI,
        PDK.SOLUONG,
        LT.NGAYTHI,
        LD.GIATIEN
    FROM PHIEU_DANG_KY PDK
    JOIN KHACH_HANG KH ON KH.MA_KH = PDK.MA_KH
    JOIN KHACH_HANG_DONVI KHDV ON KHDV.MA_KHDV = KH.MA_KH
    JOIN CHI_TIET_DANG_KY CTDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN LICH_THI LT ON LT.MA_LICH = CTDK.MA_LICH
    JOIN LOAI_DGNL LD ON LD.MA_LOAI = LT.MA_LOAI
    WHERE KH.LOAIKH = N'Đơn vị' AND KH.MA_KH = @MA_KH
END
EXEC SP_NVKT_TimChungChiKHDV_Theo_Ma_DV @MA_KH='KH0002'

CREATE PROCEDURE SP_NVKT_TimChungChiKHDV_Theo_Ten
    @TENDONVI NVARCHAR(50)
AS
BEGIN
    SELECT 
        LD.TENLOAI AS TENCHUNGCHI,
        PDK.SOLUONG,
        LT.NGAYTHI,
        LD.GIATIEN
    FROM PHIEU_DANG_KY PDK
    JOIN KHACH_HANG KH ON KH.MA_KH = PDK.MA_KH
    JOIN KHACH_HANG_DONVI KHDV ON KHDV.MA_KHDV = KH.MA_KH
    JOIN CHI_TIET_DANG_KY CTDK ON CTDK.MA_PDK = PDK.MA_PDK
    JOIN LICH_THI LT ON LT.MA_LICH = CTDK.MA_LICH
    JOIN LOAI_DGNL LD ON LD.MA_LOAI = LT.MA_LOAI
    WHERE KH.LOAIKH = N'Đơn vị' AND KHDV.TENDONVI LIKE '%' + @TENDONVI + '%'
END
go
EXEC SP_NVKT_TimChungChiKHDV_Theo_Ten @TENDONVI=N'Công ty XYZ'